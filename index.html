<!DOCTYPE html>
<html>
<head>
  <title>Connect Your Accounts</title>
  <!-- Plaid Link SDK -->
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
  <h1>Connect Your Accounts</h1>

  <!-- Authentication UI -->
  <div id="auth-container">
    <input id="email"    type="email"    placeholder="Email"    />
    <input id="password" type="password" placeholder="Password" />
    <button id="sign-up">Sign Up</button>
    <button id="sign-in">Sign In</button>
    <div id="status">Not signed in</div>
  </div>

  <!-- OAuth Connect Buttons -->
  <button id="connect-twitch" style="display:none;">Connect Twitch</button>
  <button id="connect-plaid"  style="display:none;">Connect Bank</button>

  <script type="module">
    console.log("ðŸ”¥ main.js loaded");

    // Nango public key â€“ replace with your actual pk_â€¦ value
    const NANGO_PUBLIC_KEY = 'pk_YOUR_PUBLIC_KEY_HERE';

    // 1. Firebase setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDohgKezbagI3PK_dDhcW2PylUQ1DuM5so",
      authDomain: "parsepanel-e98bd.firebaseapp.com",
      projectId: "parsepanel-e98bd",
      storageBucket: "parsepanel-e98bd.firebasestorage.app",
      messagingSenderId: "1025097171328",
      appId: "1:1025097171328:web:1870073029ab1c348a8165",
      measurementId: "G-ZE4XCB83Z7"
    };
    const app  = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // 2. Element references
    const emailInput   = document.getElementById('email');
    const passInput    = document.getElementById('password');
    const signUpBtn    = document.getElementById('sign-up');
    const signInBtn    = document.getElementById('sign-in');
    const statusDiv    = document.getElementById('status');
    const authContainer= document.getElementById('auth-container');
    const twitchBtn    = document.getElementById('connect-twitch');
    const plaidBtn     = document.getElementById('connect-plaid');

    // 3. Auth state listener
    onAuthStateChanged(auth, user => {
      if (user) {
        console.log("User signed in:", user.uid);
        localStorage.setItem('uid', user.uid);
        statusDiv.textContent = `Logged in as ${user.email}`;
        authContainer.style.display = 'none';
        twitchBtn.style.display = 'inline-block';
        plaidBtn.style.display  = 'inline-block';
      } else {
        console.log("No user signed in");
        localStorage.removeItem('uid');
        statusDiv.textContent = 'Not signed in';
        authContainer.style.display = 'block';
        twitchBtn.style.display = 'none';
        plaidBtn.style.display  = 'none';
      }
    });

    // 4. Sign-up
    signUpBtn.addEventListener('click', async () => {
      try {
        const cred = await createUserWithEmailAndPassword(auth,
          emailInput.value, passInput.value);
        console.log("Sign-up success:", cred.user.uid);
      } catch (e) {
        console.error("Sign-up error:", e);
        alert(e.message);
      }
    });

    // 5. Sign-in
    signInBtn.addEventListener('click', async () => {
      try {
        const cred = await signInWithEmailAndPassword(auth,
          emailInput.value, passInput.value);
        console.log("Sign-in success:", cred.user.uid);
      } catch (e) {
        console.error("Sign-in error:", e);
        alert(e.message);
      }
    });

    // 6. Plaid Link
    let handler;
    fetch('/api/plaid-link-token')
      .then(r => r.json())
      .then(data => {
        handler = Plaid.create({
          token: data.link_token,
          onSuccess: (public_token, metadata) => {
            console.log("Plaid success for user:", localStorage.getItem('uid'));
          }
        });
      })
      .catch(err => {
        console.error('Plaid init error:', err);
        alert('Could not load Plaid.');
      });
    plaidBtn.addEventListener('click', () => handler?.open() || alert('Plaid not ready'));

    // 7. Twitch via Nango (REST-based)
    twitchBtn.addEventListener('click', async () => {
      const uid = localStorage.getItem('uid');
      if (!uid) return alert('Please sign in first');

      try {
        const resp = await fetch('/api/nango-auth-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: uid })
        });
        if (!resp.ok) throw new Error((await resp.json()).error || 'Nango error');
        const { session_token } = await resp.json();

        const url = new URL('https://api.nango.dev/oauth/connect/twitch');
        url.searchParams.set('public_token', session_token);
        url.searchParams.set('connection_id', uid);
        console.log('Redirecting to Nango OAuth:', url.toString());
        window.location.href = url;
      } catch (e) {
        console.error('Twitch connect failed:', e);
        alert(`Connection failed: ${e.message}`);
      }
    });
  </script>
</body>
</html>
